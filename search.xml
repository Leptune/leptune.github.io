<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[日志分表]]></title>
      <url>https://leptune.github.io/2016/04/06/log-sep/</url>
      <content type="html"><![CDATA[<p>逻辑梳理：<br><a id="more"></a></p>
<h2 id="直接运行下面的php代码便可得到所有表的分表sql语句："><a href="#直接运行下面的php代码便可得到所有表的分表sql语句：" class="headerlink" title="直接运行下面的php代码便可得到所有表的分表sql语句："></a>直接运行下面的php代码便可得到所有表的分表sql语句：</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_partion_log</span><span class="params">($tables, $db_name)</span> </span>&#123;</span><br><span class="line">    $sql = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">foreach</span> ($tables <span class="keyword">as</span> $tb) &#123;</span><br><span class="line">        $sql .= <span class="string">&lt;&lt;&lt;EOF</span><br><span class="line">-- 建立临时分区表：</span><br><span class="line">-- 拷贝表结构：</span><br><span class="line">Delimiter ;</span><br><span class="line">drop table if exists <span class="subst">&#123;$tb['name']&#125;</span>_tmp;</span><br><span class="line">create table <span class="subst">&#123;$tb['name']&#125;</span>_tmp like <span class="subst">&#123;$tb['name']&#125;</span>;</span><br><span class="line">-- RANGE COLUMNS分区要求分区列不能是varchar类型，所以，要将add_time改为int类型：</span><br><span class="line">ALTER TABLE `<span class="subst">&#123;$tb['name']&#125;</span>_tmp` CHANGE COLUMN `<span class="subst">&#123;$tb['timefield']&#125;</span>` `<span class="subst">&#123;$tb['timefield']&#125;</span>` INT NOT NULL COMMENT '添加时间-时间戳';</span><br><span class="line">-- 分区列必须包含在主键里，所以要将<span class="subst">&#123;$tb['timefield']&#125;</span>包含进主键：</span><br><span class="line">ALTER TABLE `<span class="subst">&#123;$tb['name']&#125;</span>_tmp`    DROP PRIMARY KEY,  ADD PRIMARY KEY (`id`, `<span class="subst">&#123;$tb['timefield']&#125;</span>`);</span><br><span class="line">-- 增加分区（按月分区）：</span><br><span class="line">ALTER TABLE `<span class="subst">&#123;$tb['name']&#125;</span>_tmp`  PARTITION BY RANGE COLUMNS(<span class="subst">&#123;$tb['timefield']&#125;</span>)</span><br><span class="line">(PARTITION p201511 VALUES LESS THAN (UNIX_TIMESTAMP('2015-12-01')),</span><br><span class="line"> PARTITION p201512 VALUES LESS THAN (UNIX_TIMESTAMP('2016-01-01')),</span><br><span class="line"> PARTITION p201601 VALUES LESS THAN (UNIX_TIMESTAMP('2016-02-01')),</span><br><span class="line"> PARTITION p201602 VALUES LESS THAN (UNIX_TIMESTAMP('2016-03-01')),</span><br><span class="line"> PARTITION p201603 VALUES LESS THAN (UNIX_TIMESTAMP('2016-04-01')),</span><br><span class="line"> PARTITION p201604 VALUES LESS THAN (UNIX_TIMESTAMP('2016-05-01')),</span><br><span class="line"> PARTITION p201605 VALUES LESS THAN (UNIX_TIMESTAMP('2016-06-01'))</span><br><span class="line"> );</span><br><span class="line"></span><br><span class="line">-- 从<span class="subst">&#123;$tb['name']&#125;</span>表中导入数据：</span><br><span class="line">insert into <span class="subst">&#123;$tb['name']&#125;</span>_tmp select * from <span class="subst">&#123;$tb['name']&#125;</span>;</span><br><span class="line">-- 将临时表和正式表互换：</span><br><span class="line">drop table if exists <span class="subst">&#123;$tb['name']&#125;</span>_older;</span><br><span class="line">rename table <span class="subst">&#123;$tb['name']&#125;</span> to <span class="subst">&#123;$tb['name']&#125;</span>_older;</span><br><span class="line">rename table <span class="subst">&#123;$tb['name']&#125;</span>_tmp to <span class="subst">&#123;$tb['name']&#125;</span>;</span><br><span class="line"></span><br><span class="line">-- 创建数据库定时任务（每个月的1号的凌晨1点执行上面创建的存储器）：</span><br><span class="line">DELIMITER $$</span><br><span class="line">DROP EVENT IF EXISTS `eSetPartition_<span class="subst">&#123;$tb['name']&#125;</span>`;</span><br><span class="line">$$</span><br><span class="line">CREATE EVENT eSetPartition_<span class="subst">&#123;$tb['name']&#125;</span></span><br><span class="line">ON SCHEDULE EVERY 1 MONTH STARTS DATE_ADD(DATE_ADD(DATE_SUB(CURDATE(),INTERVAL DAY(CURDATE())-1 DAY), INTERVAL 1 MONTH),INTERVAL 1 HOUR)   </span><br><span class="line">ON COMPLETION PRESERVE ENABLE  </span><br><span class="line">COMMENT '对<span class="subst">&#123;$tb['name']&#125;</span>表每个月1号的凌晨1点自动执行分区' </span><br><span class="line">DO</span></span><br><span class="line">BEGIN</span><br><span class="line">    call SetPartitionTimestamp(<span class="string">'&#123;$tb['</span>name<span class="string">']&#125;'</span>);</span><br><span class="line">END;</span><br><span class="line">$$</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EOF;</span><br><span class="line">    &#125;</span><br><span class="line">    $sql .= <span class="string">&lt;&lt;&lt;EOF</span><br><span class="line">-- 创建存储过程来自动为每个月创建分区：</span><br><span class="line">DELIMITER $$</span><br><span class="line">DROP PROCEDURE IF EXISTS `SetPartitionTimestamp`;</span><br><span class="line">$$</span><br><span class="line">CREATE PROCEDURE SetPartitionTimestamp(IN tb_name varchar(30))</span><br><span class="line">COMMENT '对timestamp字段类型按每个月划分分区'</span><br><span class="line">BEGIN</span></span><br><span class="line">    SET @db_name = <span class="string">'&#123;$db_name&#125;'</span>;</span><br><span class="line">    SET @part_prefix = <span class="string">'p'</span>;</span><br><span class="line">    SELECT REPLACE(partition_name,@part_prefix,<span class="string">''</span>) INTO @last_year_mon</span><br><span class="line">        FROM INFORMATION_SCHEMA.PARTITIONS</span><br><span class="line">        WHERE TABLE_SCHEMA=@db_name <span class="keyword">AND</span> table_name=tb_name</span><br><span class="line">        ORDER BY partition_ordinal_position DESC</span><br><span class="line">        LIMIT <span class="number">1</span>;</span><br><span class="line">    select PERIOD_ADD(@last_year_mon,<span class="number">1</span>) into @next_year_mon;</span><br><span class="line">    select PERIOD_ADD(@next_year_mon,<span class="number">1</span>) into @next_next_year_mon;</span><br><span class="line">    SET @exec_sql = CONCAT(<span class="string">'ALTER TABLE `'</span>, tb_name, <span class="string">'` ADD PARTITION (PARTITION '</span>, @part_prefix, @next_year_mon, <span class="string">' VALUES LESS THAN (UNIX_TIMESTAMP(\''</span>, @next_next_year_mon, <span class="string">'01\')))'</span>);</span><br><span class="line">    PREPARE stmt2 FROM @exec_sql;</span><br><span class="line">    EXECUTE stmt2;</span><br><span class="line">    DEALLOCATE PREPARE stmt2;</span><br><span class="line">END;</span><br><span class="line">$$</span><br><span class="line">-- 开启event：</span><br><span class="line">SET <span class="keyword">GLOBAL</span> event_scheduler = ON;</span><br><span class="line">SET @@<span class="keyword">global</span>.event_scheduler = ON;</span><br><span class="line">SET <span class="keyword">GLOBAL</span> event_scheduler = <span class="number">1</span>;</span><br><span class="line">SET @@<span class="keyword">global</span>.event_scheduler = <span class="number">1</span>;</span><br><span class="line">$$</span><br><span class="line">EOF;</span><br><span class="line">    <span class="keyword">return</span> $sql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$tables = [ <span class="comment">// 表名、分列字段</span></span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_zhushou_update_log'</span>   , <span class="string">'timefield'</span> =&gt; <span class="string">'updateDate'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_zhushou_uninstall_log'</span>, <span class="string">'timefield'</span> =&gt; <span class="string">'updateDate'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_zhushou_run_log'</span>      , <span class="string">'timefield'</span> =&gt; <span class="string">'updateDate'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_zhushou_install_log'</span>  , <span class="string">'timefield'</span> =&gt; <span class="string">'updateDate'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_zhushou_down_log'</span>     , <span class="string">'timefield'</span> =&gt; <span class="string">'downDate'</span>  ],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_syb_down_log'</span>         , <span class="string">'timefield'</span> =&gt; <span class="string">'downDate'</span>  ],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_simulator_run_log'</span>    , <span class="string">'timefield'</span> =&gt; <span class="string">'updateDate'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_simulator_install_log'</span>, <span class="string">'timefield'</span> =&gt; <span class="string">'updateDate'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_phone_install_log'</span>    , <span class="string">'timefield'</span> =&gt; <span class="string">'updateDate'</span>],</span><br><span class="line">    [<span class="string">'name'</span> =&gt; <span class="string">'dx_game_log'</span>             , <span class="string">'timefield'</span> =&gt; <span class="string">'add_time'</span>  ],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> gen_partion_log($tables, <span class="string">'scp_shuowan_tj_local'</span>).<span class="string">"\n"</span>;</span><br></pre></td></tr></table></figure>
<h2 id="运行下面的sql语句可用于查询分表后的性能"><a href="#运行下面的sql语句可用于查询分表后的性能" class="headerlink" title="运行下面的sql语句可用于查询分表后的性能"></a>运行下面的sql语句可用于查询分表后的性能</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查看插入的数据是否有按分区存放：</span></span><br><span class="line">Delimiter ;</span><br><span class="line"><span class="keyword">SELECT</span> PARTITION_NAME <span class="keyword">as</span> 分区名,PARTITION_ORDINAL_POSITION <span class="keyword">as</span> 分区顺序, PARTITION_DESCRIPTION <span class="keyword">as</span> 分区条件, TABLE_ROWS <span class="keyword">as</span> 分区行数</span><br><span class="line"><span class="keyword">FROM</span> information_schema.PARTITIONS </span><br><span class="line"><span class="keyword">WHERE</span> TABLE_SCHEMA=<span class="string">'scp_shuowan_tj_local'</span> <span class="keyword">AND</span> TABLE_NAME = <span class="string">'dx_game_log'</span>;</span><br><span class="line"><span class="comment">--对比分区前后查询速度：</span></span><br><span class="line"><span class="comment">--分区前的查询速度（结果：查询时间约0.4s）：</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> dx_game_log_older <span class="keyword">where</span> add_time &gt;= <span class="keyword">unix_timestamp</span>(<span class="string">'2016-03-01'</span>) <span class="keyword">and</span> add_time &lt; <span class="keyword">unix_timestamp</span>(<span class="string">'2016-04-01'</span>);</span><br><span class="line"><span class="comment">--分区后的查询速度（结果：查询时间约0.1s）：</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> dx_game_log <span class="keyword">where</span> add_time &gt;= <span class="keyword">unix_timestamp</span>(<span class="string">'2016-03-01'</span>) <span class="keyword">and</span> add_time &lt; <span class="keyword">unix_timestamp</span>(<span class="string">'2016-04-01'</span>);</span><br><span class="line"><span class="comment">--查看分区后，执行的查询有扫描哪些分区（结果：只扫描了p201603分区。若将&lt;改为&lt;=，则会扫描p201603,p201604两个分区）：</span></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">partitions</span> <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> dx_game_log <span class="keyword">where</span> add_time &gt;= <span class="keyword">unix_timestamp</span>(<span class="string">'2016-03-01'</span>) <span class="keyword">and</span> add_time &lt; <span class="keyword">unix_timestamp</span>(<span class="string">'2016-04-01'</span>);</span><br></pre></td></tr></table></figure>
<h2 id="确认无误后，删除旧的未分表的表："><a href="#确认无误后，删除旧的未分表的表：" class="headerlink" title="确认无误后，删除旧的未分表的表："></a>确认无误后，删除旧的未分表的表：</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Delimiter ;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_zhushou_update_log_older;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_zhushou_uninstall_log_older;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_zhushou_run_log_older;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_zhushou_install_log_older;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_zhushou_down_log_older;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_syb_down_log_older;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_simulator_run_log_older;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_simulator_install_log_older;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_phone_install_log_older;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> dx_game_log_older;</span><br></pre></td></tr></table></figure>
<hr>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hello World leptune]]></title>
      <url>https://leptune.github.io/2016/04/06/hello-world/</url>
      <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<a id="more"></a>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    </entry>
    
  
  
</search>
